{% extends "base.html" %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <h4>Rooms</h4>
        <ul class="list-group" id="room-list">
            {% for room in rooms %}
            <li class="list-group-item room-item" data-room="{{ room }}">{{ room }}</li>
            {% endfor %}
        </ul>
        <button class="btn btn-secondary mt-3" id="create-room-btn">Create Room</button>
    </div>
    <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 id="current-room">General</h4>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
        </div>
        <div id="messages" class="border p-3 mb-3" style="height: 400px; overflow-y: auto;"></div>
        <form id="message-form" class="d-flex">
            <input type="text" id="message-input" class="form-control me-2" placeholder="Type a message..." required>
            <input type="file" id="file-input" class="form-control me-2" style="display: none;">
            <button type="button" id="file-btn" class="btn btn-outline-secondary me-2">ðŸ“Ž</button>
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const username = '{{ username }}';
    const socket = io();
    let currentRoom = 'general';

    // Join initial room
    socket.emit('join', {room: currentRoom});

    // Load message history
    socket.emit('load_history', {room: currentRoom});

    // Handle room selection
    document.querySelectorAll('.room-item').forEach(item => {
        item.addEventListener('click', () => {
            socket.emit('leave', {room: currentRoom});
            currentRoom = item.dataset.room;
            document.getElementById('current-room').textContent = currentRoom;
            document.getElementById('messages').innerHTML = '';
            socket.emit('join', {room: currentRoom});
            socket.emit('load_history', {room: currentRoom});
        });
    });

    // Handle message form
    document.getElementById('message-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        if (message) {
            socket.emit('message', {msg: message, room: currentRoom});
            messageInput.value = '';
        }
    });

    // Handle file upload
    document.getElementById('file-btn').addEventListener('click', () => {
        document.getElementById('file-input').click();
    });

    document.getElementById('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('file', file);
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.url) {
                    socket.emit('message', {msg: `<a href="${data.url}" target="_blank">${file.name}</a>`, room: currentRoom});
                }
            });
        }
    });

    // Handle create room
    document.getElementById('create-room-btn').addEventListener('click', () => {
        const roomName = prompt('Enter room name:');
        if (roomName) {
            const roomList = document.getElementById('room-list');
            const newRoom = document.createElement('li');
            newRoom.className = 'list-group-item room-item';
            newRoom.dataset.room = roomName;
            newRoom.textContent = roomName;
            roomList.appendChild(newRoom);
            newRoom.addEventListener('click', () => {
                socket.emit('leave', {room: currentRoom});
                currentRoom = roomName;
                document.getElementById('current-room').textContent = currentRoom;
                document.getElementById('messages').innerHTML = '';
                socket.emit('join', {room: currentRoom});
                socket.emit('load_history', {room: currentRoom});
            });
        }
    });

    // Socket event listeners
    socket.on('message', (data) => {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.innerHTML = `<strong>${data.username}</strong> [${data.timestamp}]: ${data.msg}`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    socket.on('status', (data) => {
        const messagesDiv = document.getElementById('messages');
        const statusDiv = document.createElement('div');
        statusDiv.className = 'text-muted';
        statusDiv.textContent = data.msg;
        messagesDiv.appendChild(statusDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    socket.on('history', (history) => {
        const messagesDiv = document.getElementById('messages');
        history.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `<strong>${msg.username}</strong> [${msg.timestamp}]: ${msg.msg}`;
            messagesDiv.appendChild(messageDiv);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
</script>
{% endblock %}
